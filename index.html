<!DOCTYPE html>
<html>
<head>
  <title>แผนที่ OpenStreetMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <style>
    body, html, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .distance-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="distance-info" id="distanceInfo" style="display: none;"></div>
<script>
  const map = L.map('map').setView([16.8725173, 99.1322329], 10);

  // เพิ่ม Tile Layer สำหรับแผนที่
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
  }).addTo(map);

  let markers = []; // สร้างตัวแปรสำหรับเก็บมาร์กเกอร์
  let userMarker; // มาร์กเกอร์สำหรับตำแหน่งปัจจุบันของผู้ใช้
  let routingControl; // ควบคุมเส้นทาง
  let loadingPopup; // Popup สำหรับแสดงข้อความ "กำลังดึงตำแหน่ง"

  // ฟังก์ชันอัปเดตหมุดบนแผนที่
  function updateMarkers(data) {
    // ลบหมุดเก่า
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];

    // เพิ่มหมุดใหม่
    data.forEach(item => {
      const marker = L.marker([item.ละติจูด, item.ลองจิจูด]).addTo(map);
      marker.bindPopup(`${item.ชื่อ} ${item.นามสกุล}<br>โรคประจำตัว: ${item.โรคประจำตัว}`);
      markers.push(marker);

      // เมื่อกดหมุด ให้คำนวณระยะทางและแสดงเส้นทาง
      marker.on('click', () => {
        if (userMarker) {
          const userLatLng = userMarker.getLatLng();
          const markerLatLng = marker.getLatLng();

          // คำนวณระยะทาง
          const distance = userLatLng.distanceTo(markerLatLng) / 1000; // แปลงเป็นกิโลเมตร
          document.getElementById('distanceInfo').innerHTML = `ระยะทาง: ${distance.toFixed(2)} กิโลเมตร`;
          document.getElementById('distanceInfo').style.display = 'block';

          // แสดงเส้นทาง
          if (routingControl) {
            map.removeControl(routingControl);
          }
          routingControl = L.Routing.control({
            waypoints: [userLatLng, markerLatLng],
            routeWhileDragging: true,
            showAlternatives: false
          }).addTo(map);
        }
      });
    });
  }

  // ฟังก์ชันดึงข้อมูลจาก Google Apps Script
  function fetchData() {
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbwG2tXe8pT-PtVRiFPygktiFUmHaDNjpX8VLNZsb7oDBCPYLCQg4coukHZfjDAXc6M-/exec';
    fetch(scriptUrl)
      .then(response => response.json())
      .then(data => updateMarkers(data))
      .catch(error => console.error('Error fetching data:', error));
  }

  // ฟังก์ชันดึงตำแหน่งปัจจุบันของผู้ใช้
  function getUserLocation() {
    if (navigator.geolocation) {
      // แสดง popup "กำลังดึงตำแหน่งของท่าน"
      loadingPopup = L.popup()
        .setLatLng(map.getCenter()) // วางตรงกลางแผนที่
        .setContent("กำลังดึงตำแหน่งของท่าน...")
        .openOn(map);

      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;

          // ลบ popup หลังจากดึงตำแหน่งสำเร็จ
          map.closePopup(loadingPopup);

          // เพิ่มมาร์กเกอร์ตำแหน่งปัจจุบัน (สีเขียว)
          if (userMarker) {
            map.removeLayer(userMarker);
          }
          const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          });
          userMarker = L.marker([latitude, longitude], { icon: greenIcon }).addTo(map);
          userMarker.bindPopup("ตำแหน่งของคุณ").openPopup();

          // เซ็ตแผนที่ให้โฟกัสที่ตำแหน่งปัจจุบัน
          map.setView([latitude, longitude], 15);
        },
        error => {
          console.error('Error getting user location:', error);
          map.closePopup(loadingPopup); // ลบ popup หากเกิดข้อผิดพลาด
          alert('ไม่สามารถดึงตำแหน่งของคุณได้ กรุณาตรวจสอบการอนุญาต');
        }
      );
    } else {
      alert('เบราว์เซอร์ของคุณไม่รองรับ Geolocation');
    }
  }

  // เรียกใช้งานฟังก์ชัน
  fetchData();
  setInterval(fetchData, 5000); // อัปเดตข้อมูลทุก 5 วินาที
  getUserLocation(); // ดึงตำแหน่งปัจจุบันเมื่อโหลดหน้าเว็บ
</script>
</body>
</html>
